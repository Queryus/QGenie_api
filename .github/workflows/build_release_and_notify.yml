# .github/workflows/build_release_and_notify.yml

name: Build and Deploy Executables

on:
  release:
    types: [published] # Releaseê°€ 'published' ìƒíƒœê°€ ë  ë•Œ íŠ¸ë¦¬ê±°

jobs:
  # ==================================
  #    íŒŒì´í”„ë¼ì¸ ì‹œì‘ ì•Œë¦¼
  # ==================================
  start:
    runs-on: ubuntu-latest
    steps:
      - name: Send Pipeline Start Notification
        uses: antoinezanardi/discord-webhook-action@v2
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          color: "#31a6f5" # ë…¸ë€ìƒ‰
          username: "íŒŒì´í”„ë¼ì¸ ë´‡"
          description: "ğŸ”·ğŸ”·ğŸ”·  **${{ github.ref_name }}** ë¦´ë¦¬ì¦ˆ ë°°í¬ íŒŒì´í”„ë¼ì¸ì„ ì‹œì‘í•©ë‹ˆë‹¤.  ğŸ”·ğŸ”·ğŸ”·"
  # ==================================
  #    ì‹¤í–‰ íŒŒì¼ ë¹Œë“œ
  # ==================================
  build:
    needs: start
    strategy:
      matrix:
        os: [macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      # 1. Git ë¦¬í¬ì§€í† ë¦¬ì˜ ì†ŒìŠ¤ ì½”ë“œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Poetry ì„¤ì¹˜ (ë””ë²„ê¹… ì¶œë ¥ ì¶”ê°€)
      - name: Install Poetry
        shell: bash
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            echo "C:/Users/runneradmin/AppData/Roaming/Python/Scripts" >> $GITHUB_PATH
          else
            echo "$HOME/.local/bin" >> $GITHUB_PATH
          fi

      # 3. Poetryë¥¼ ì‚¬ìš©í•˜ì—¬ íŒŒì´ì¬ í™˜ê²½ì„ ì„¤ì •í•©ë‹ˆë‹¤.
      - name: Set up Python with Poetry
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "poetry"

      # 4. Poetry ì˜ì¡´ì„±(PyInstaller í¬í•¨)ì„ ì„¤ì¹˜í•©ë‹ˆë‹¤.
      - name: Install Poetry dependencies
        run: poetry install --no-root

      # 5. OSì— ë”°ë¼ ì‹¤í–‰ íŒŒì¼ì˜ ì´ë¦„(.exe í™•ì¥ì ë“±)ì„ ê²°ì •í•©ë‹ˆë‹¤.
      - name: Set executable name
        id: set_name
        shell: bash
        run: |
          if [ "${{ runner.os }}" == "macOS" ]; then
            echo "EXE_NAME=qgenie-api" >> $GITHUB_ENV
          elif [ "${{ runner.os }}" == "Windows" ]; then
            echo "EXE_NAME=qgenie-api.exe" >> $GITHUB_ENV
          fi

      # 6. PyInstallerë¥¼ ì‚¬ìš©í•´ íŒŒì´ì¬ ì½”ë“œë¥¼ ì‹¤í–‰ íŒŒì¼ë¡œ ë§Œë“­ë‹ˆë‹¤.
      - name: Build executable with PyInstaller
        run: poetry run pyinstaller main.py --name ${{ env.EXE_NAME }} --onefile --noconsole

      # 7. ë¹Œë“œëœ ì‹¤í–‰ íŒŒì¼ì„ ë‹¤ìŒ ë‹¨ê³„(deploy)ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œí•©ë‹ˆë‹¤.
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: executable-${{ runner.os }}
          path: dist/${{ env.EXE_NAME }}
          retention-days: 1

  # ==================================
  #    ë°°í¬
  # ==================================
  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout App Repository
        uses: actions/checkout@v4
        with:
          repository: Queryus/QGenie_app
          token: ${{ secrets.PAT_FOR_FRONT_REPO }}
          ref: develop

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Organize files
        run: |
          mkdir -p resources/mac resources/win
          mv artifacts/executable-macOS/qgenie-api resources/mac/
          mv artifacts/executable-Windows/qgenie-api.exe resources/win/

      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions'
          git config --global user.email 'github-actions@github.com'
          git add .
          if git diff-index --quiet HEAD; then
            echo "No changes to commit to QGenie APP repository."
          else
            git commit -m "feat: API ì‹¤í–‰ íŒŒì¼ ì—…ë°ì´íŠ¸ (${{ github.ref_name }})"
            git push
          fi

  # ==================================
  #    íŒŒì´í”„ë¼ì¸ ìµœì¢… ê²°ê³¼ ì•Œë¦¼
  # ==================================
  finish:
    needs: deploy
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Send Success Notification
        if: needs.deploy.result == 'success'
        uses: antoinezanardi/discord-webhook-action@v2
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          color: "#2ecc71" # ì´ˆë¡ìƒ‰
          username: "íŒŒì´í”„ë¼ì¸ ë´‡"
          title: "ğŸ‰ New Release: ${{ github.ref_name }}"
          url: ${{ github.event.release.html_url }}
          description: "âœ…âœ…âœ…  **${{ github.ref_name }}** ë¦´ë¦¬ì¦ˆ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!  âœ…âœ…âœ…"

      - name: Send Failure Notification
        if: needs.deploy.result == 'failure'
        uses: antoinezanardi/discord-webhook-action@v2
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          color: "#e74c3c" # ë¹¨ê°„ìƒ‰
          username: "íŒŒì´í”„ë¼ì¸ ë´‡"
          description: "âŒâŒâŒ  **${{ github.ref_name }}** ë¦´ë¦¬ì¦ˆ ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.  âŒâŒâŒ"
          url: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Send Skipped or Cancelled Notification
        if: needs.deploy.result == 'skipped' || needs.deploy.result == 'cancelled'
        uses: antoinezanardi/discord-webhook-action@v2
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          color: "#fcf56f" # ë…¸ë€ìƒ‰
          username: "íŒŒì´í”„ë¼ì¸ ë´‡"
          description: "ğŸŸ¡ğŸŸ¡ğŸŸ¡  **${{ github.ref_name }}** ë¦´ë¦¬ì¦ˆ ë°°í¬ê°€ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (ìƒíƒœ: `${{ needs.deploy.result }}`)\nì´ì „ ë‹¨ê³„(Build)ì—ì„œ ë¬¸ì œê°€ ë°œìƒí–ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.  ğŸŸ¡ğŸŸ¡ğŸŸ¡"
          url: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
